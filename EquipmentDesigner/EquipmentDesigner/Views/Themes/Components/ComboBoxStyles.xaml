<ResourceDictionary
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:sys="clr-namespace:System;assembly=mscorlib">

    <!-- ============================================================
         Custom ComboBox Styles
         Design System에 맞는 커스텀 드롭다운 스타일
         ============================================================ -->

    <ResourceDictionary.MergedDictionaries>
        <ResourceDictionary Source="../Tokens/Colors.xaml"/>
        <ResourceDictionary Source="../Tokens/Brushes.xaml"/>
        <ResourceDictionary Source="../Tokens/Typography.xaml"/>
        <ResourceDictionary Source="../Tokens/Spacing.xaml"/>
        <ResourceDictionary Source="../Tokens/Effects.xaml"/>
    </ResourceDictionary.MergedDictionaries>

    <!-- ComboBox Toggle Button Template -->
    <ControlTemplate x:Key="ComboBoxToggleButton" TargetType="ToggleButton">
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition/>
                <ColumnDefinition Width="32"/>
            </Grid.ColumnDefinitions>

            <!-- Main Background -->
            <Border x:Name="Border"
                    Grid.ColumnSpan="2"
                    Background="{StaticResource Brush.Input.Background}"
                    BorderBrush="{StaticResource Brush.Input.Border}"
                    BorderThickness="{StaticResource Border.Thin}"
                    CornerRadius="{StaticResource Radius.LG}"/>

            <!-- Arrow Container -->
            <Border x:Name="ArrowBorder"
                    Grid.Column="1"
                    Background="Transparent"
                    CornerRadius="0,8,8,0">
                <Path x:Name="Arrow"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Center"
                      Data="M0,0 L4,4 L8,0"
                      Stroke="{StaticResource Brush.Text.Secondary}"
                      StrokeThickness="1.5"
                      StrokeLineJoin="Round"
                      RenderTransformOrigin="0.5,0.5">
                    <Path.RenderTransform>
                        <RotateTransform Angle="0"/>
                    </Path.RenderTransform>
                </Path>
            </Border>
        </Grid>

        <ControlTemplate.Triggers>
            <!-- Hover State -->
            <Trigger Property="IsMouseOver" Value="True">
                <Setter TargetName="Border" Property="Background" Value="{StaticResource Brush.Input.Background.Hover}"/>
                <Setter TargetName="Border" Property="BorderBrush" Value="{StaticResource Brush.Input.Border.Hover}"/>
                <Setter TargetName="Arrow" Property="Stroke" Value="{StaticResource Brush.Text.Primary}"/>
            </Trigger>

            <!-- Checked (Dropdown Open) State -->
            <Trigger Property="IsChecked" Value="True">
                <Setter TargetName="Border" Property="BorderBrush" Value="{StaticResource Brush.Input.Border.Focus}"/>
                <Trigger.EnterActions>
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation Storyboard.TargetName="Arrow"
                                             Storyboard.TargetProperty="(Path.RenderTransform).(RotateTransform.Angle)"
                                             To="180"
                                             Duration="0:0:0.2">
                                <DoubleAnimation.EasingFunction>
                                    <CubicEase EasingMode="EaseOut"/>
                                </DoubleAnimation.EasingFunction>
                            </DoubleAnimation>
                        </Storyboard>
                    </BeginStoryboard>
                </Trigger.EnterActions>
                <Trigger.ExitActions>
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation Storyboard.TargetName="Arrow"
                                             Storyboard.TargetProperty="(Path.RenderTransform).(RotateTransform.Angle)"
                                             To="0"
                                             Duration="0:0:0.2">
                                <DoubleAnimation.EasingFunction>
                                    <CubicEase EasingMode="EaseOut"/>
                                </DoubleAnimation.EasingFunction>
                            </DoubleAnimation>
                        </Storyboard>
                    </BeginStoryboard>
                </Trigger.ExitActions>
            </Trigger>

            <!-- Disabled State -->
            <Trigger Property="IsEnabled" Value="False">
                <Setter TargetName="Border" Property="Background" Value="{StaticResource Brush.Input.Background.Disabled}"/>
                <Setter TargetName="Border" Property="BorderBrush" Value="{StaticResource Brush.Border.Disabled}"/>
                <Setter TargetName="Arrow" Property="Stroke" Value="{StaticResource Brush.Text.Disabled}"/>
            </Trigger>
        </ControlTemplate.Triggers>
    </ControlTemplate>

    <!-- ComboBox TextBox Template (for editable mode) -->
    <ControlTemplate x:Key="ComboBoxTextBox" TargetType="TextBox">
        <Border x:Name="PART_ContentHost"
                Focusable="False"
                Background="{TemplateBinding Background}"/>
    </ControlTemplate>

    <!-- ComboBoxItem Style -->
    <Style x:Key="StyledComboBoxItem" TargetType="ComboBoxItem">
        <Setter Property="SnapsToDevicePixels" Value="True"/>
        <Setter Property="Padding" Value="12,10"/>
        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
        <Setter Property="VerticalContentAlignment" Value="Center"/>
        <Setter Property="Background" Value="Transparent"/>
        <Setter Property="BorderBrush" Value="Transparent"/>
        <Setter Property="BorderThickness" Value="0"/>
        <Setter Property="FontFamily" Value="{StaticResource Font.Family.Primary}"/>
        <Setter Property="FontSize" Value="{StaticResource Font.Size.Base}"/>
        <Setter Property="Foreground" Value="{StaticResource Brush.Text.Primary}"/>
        <Setter Property="Cursor" Value="Hand"/>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="ComboBoxItem">
                    <Border x:Name="Bd"
                            Background="{TemplateBinding Background}"
                            BorderBrush="{TemplateBinding BorderBrush}"
                            BorderThickness="{TemplateBinding BorderThickness}"
                            Padding="{TemplateBinding Padding}"
                            CornerRadius="6"
                            Margin="4,2"
                            TextElement.Foreground="{TemplateBinding Foreground}">
                        <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                          VerticalAlignment="{TemplateBinding VerticalContentAlignment}"/>
                    </Border>
                    <ControlTemplate.Triggers>
                        <!-- Hover State -->
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter TargetName="Bd" Property="Background" Value="{StaticResource Brush.Selection.Background}"/>
                        </Trigger>

                        <!-- Selected State -->
                        <Trigger Property="IsSelected" Value="True">
                            <Setter TargetName="Bd" Property="Background" Value="{StaticResource Brush.Status.Active.Background}"/>
                            <Setter TargetName="Bd" Property="TextElement.Foreground" Value="{StaticResource Brush.Status.Active}"/>
                        </Trigger>

                        <!-- Disabled State -->
                        <Trigger Property="IsEnabled" Value="False">
                            <Setter TargetName="Bd" Property="TextElement.Foreground" Value="{StaticResource Brush.Text.Disabled}"/>
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

    <!-- Main ComboBox Style -->
    <Style x:Key="StyledComboBox" TargetType="ComboBox">
        <Setter Property="SnapsToDevicePixels" Value="True"/>
        <Setter Property="OverridesDefaultStyle" Value="True"/>
        <Setter Property="ScrollViewer.HorizontalScrollBarVisibility" Value="Auto"/>
        <Setter Property="ScrollViewer.VerticalScrollBarVisibility" Value="Auto"/>
        <Setter Property="ScrollViewer.CanContentScroll" Value="True"/>
        <Setter Property="MinHeight" Value="{StaticResource Size.Input.Height.MD}"/>
        <Setter Property="MinWidth" Value="120"/>
        <Setter Property="FontFamily" Value="{StaticResource Font.Family.Primary}"/>
        <Setter Property="FontSize" Value="{StaticResource Font.Size.Base}"/>
        <Setter Property="Foreground" Value="{StaticResource Brush.Text.Primary}"/>
        <Setter Property="Background" Value="{StaticResource Brush.Input.Background}"/>
        <Setter Property="BorderBrush" Value="{StaticResource Brush.Input.Border}"/>
        <Setter Property="BorderThickness" Value="{StaticResource Border.Thin}"/>
        <Setter Property="Padding" Value="12,0,0,0"/>
        <Setter Property="ItemContainerStyle" Value="{StaticResource StyledComboBoxItem}"/>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="ComboBox">
                    <Grid>
                        <!-- Toggle Button (main visual) -->
                        <ToggleButton x:Name="ToggleButton"
                                      Template="{StaticResource ComboBoxToggleButton}"
                                      Grid.Column="2"
                                      Focusable="False"
                                      ClickMode="Press"
                                      IsChecked="{Binding IsDropDownOpen, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}"
                                      Foreground="{TemplateBinding Foreground}"/>

                        <!-- Selected Content Display -->
                        <ContentPresenter x:Name="ContentSite"
                                          IsHitTestVisible="False"
                                          Content="{TemplateBinding SelectionBoxItem}"
                                          ContentTemplate="{TemplateBinding SelectionBoxItemTemplate}"
                                          ContentTemplateSelector="{TemplateBinding ItemTemplateSelector}"
                                          Margin="12,0,36,0"
                                          VerticalAlignment="Center"
                                          HorizontalAlignment="Left"
                                          TextElement.Foreground="{TemplateBinding Foreground}"/>

                        <!-- Editable TextBox (for IsEditable=True) -->
                        <TextBox x:Name="PART_EditableTextBox"
                                 Style="{x:Null}"
                                 Template="{StaticResource ComboBoxTextBox}"
                                 HorizontalAlignment="Left"
                                 VerticalAlignment="Center"
                                 Margin="12,0,32,0"
                                 Focusable="True"
                                 Background="Transparent"
                                 Foreground="{TemplateBinding Foreground}"
                                 FontFamily="{TemplateBinding FontFamily}"
                                 FontSize="{TemplateBinding FontSize}"
                                 Visibility="Hidden"
                                 IsReadOnly="{TemplateBinding IsReadOnly}"/>

                        <!-- Dropdown Popup -->
                        <Popup x:Name="Popup"
                               Placement="Bottom"
                               IsOpen="{TemplateBinding IsDropDownOpen}"
                               AllowsTransparency="True"
                               Focusable="False"
                               PopupAnimation="Fade">

                            <!-- Popup Container with Shadow -->
                            <Grid x:Name="DropDown"
                                  SnapsToDevicePixels="True"
                                  MinWidth="{TemplateBinding ActualWidth}"
                                  MaxHeight="{TemplateBinding MaxDropDownHeight}"
                                  Margin="8,4,8,8">

                                <!-- Shadow Border -->
                                <Border x:Name="DropDownBorder"
                                        Background="{StaticResource Brush.Surface.Elevated}"
                                        BorderBrush="{StaticResource Brush.Border.Primary}"
                                        BorderThickness="{StaticResource Border.Thin}"
                                        CornerRadius="{StaticResource Radius.LG}"
                                        Effect="{StaticResource Shadow.LG}">

                                    <ScrollViewer Margin="4" SnapsToDevicePixels="True">
                                        <StackPanel IsItemsHost="True"
                                                    KeyboardNavigation.DirectionalNavigation="Contained"/>
                                    </ScrollViewer>
                                </Border>
                            </Grid>
                        </Popup>
                    </Grid>

                    <ControlTemplate.Triggers>
                        <!-- HasItems -->
                        <Trigger Property="HasItems" Value="False">
                            <Setter TargetName="DropDownBorder" Property="MinHeight" Value="95"/>
                        </Trigger>

                        <!-- IsEditable -->
                        <Trigger Property="IsEditable" Value="True">
                            <Setter Property="IsTabStop" Value="False"/>
                            <Setter TargetName="PART_EditableTextBox" Property="Visibility" Value="Visible"/>
                            <Setter TargetName="ContentSite" Property="Visibility" Value="Hidden"/>
                        </Trigger>

                        <!-- IsGrouping -->
                        <Trigger Property="IsGrouping" Value="True">
                            <Setter Property="ScrollViewer.CanContentScroll" Value="False"/>
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

    <!-- Language Selector Specific Style (더 작고 컴팩트한 버전) -->
    <Style x:Key="LanguageSelectorComboBox" TargetType="ComboBox" BasedOn="{StaticResource StyledComboBox}">
        <Setter Property="MinWidth" Value="120"/>
        <Setter Property="MaxWidth" Value="160"/>
        <Setter Property="Padding" Value="12,0,0,0"/>
    </Style>

</ResourceDictionary>